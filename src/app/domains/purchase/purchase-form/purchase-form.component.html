<div class="form-container">
    <nz-page-header nzTitle="Add Purchase" nzSubtitle="Create new purchase entry" class="site-page-header">
        <nz-breadcrumb [nzAutoGenerate]="true" nz-page-header-breadcrumb></nz-breadcrumb>
    </nz-page-header>

    <nz-card [nzBordered]="false" class="master-card" nzType="inner">
        <form nz-form nzLayout="vertical" [formGroup]="form">
            <div formGroupName="purchaseMaster" nz-row nzGutter="16">
                <div nz-col [nzXs]="12" [nzMd]="6" [nzLg]="3">
                    <nz-form-item>
                        <nz-form-label>Bill No.</nz-form-label>
                        <nz-form-control><input nz-input formControlName="billNo" readonly
                                class="read-only-input" /></nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzXs]="12" [nzMd]="6" [nzLg]="3">
                    <nz-form-item>
                        <nz-form-label>Save Date</nz-form-label>
                        <nz-form-control><input nz-input formControlName="saveDate" readonly
                                class="read-only-input" /></nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzXs]="12" [nzMd]="6" [nzLg]="3">
                    <nz-form-item>
                        <nz-form-label>Supplier Bill No</nz-form-label>
                        <nz-form-control><input nz-input placeholder="Bill no."
                                formControlName="supplierBillNo" /></nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzXs]="12" [nzMd]="6" [nzLg]="3">
                    <nz-form-item>
                        <nz-form-label>Supplier Date</nz-form-label>
                        <nz-form-control><input appBsDateInput nz-input placeholder="Date"
                                formControlName="supplierSaveDate" /></nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzXs]="24" [nzMd]="8" [nzLg]="4">
                    <nz-form-item>
                        <nz-form-label>Pay Type</nz-form-label>
                        <nz-select nzShowSearch nzPlaceHolder="Select pay type" formControlName="payTypeId">
                            @for (item of payTypeSignal(); track item.id) {
                            <nz-option [nzValue]="item.id" [nzLabel]="item.name"></nz-option>
                            }
                        </nz-select>
                    </nz-form-item>
                </div>
                <div nz-col [nzXs]="24" [nzMd]="8" [nzLg]="4">
                    <nz-form-item>
                        <nz-form-label>Supplier</nz-form-label>
                        <nz-select nzShowSearch [nzDisabled]="mode === 'edit'" formControlName="supplierId">
                            @for (item of supplierListSignal(); track item.supplierId) {
                            <nz-option [nzValue]="item.supplierId" [nzLabel]="item.name"></nz-option>
                            }
                        </nz-select>
                    </nz-form-item>
                </div>
                <div nz-col [nzXs]="24" [nzMd]="8" [nzLg]="4">
                    <nz-form-item>
                        <nz-form-label class="font-bold">Total Amount</nz-form-label>
                        <nz-form-control>
                            <input class="total-display-input" readonly nz-input
                                [value]="totalAmountSignal() | number:'1.2-2'" />
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="24" [nzMd]="8" [nzLg]="6">
                    <nz-form-item>
                        <nz-form-label>Remarks</nz-form-label>
                        <nz-form-control>
                            <textarea nz-input rows="4" placeholder="Enter remarks..."
                                formControlName="remarks"></textarea>
                        </nz-form-control>
                    </nz-form-item>
                </div>
            </div>

            <nz-divider nzText="Item Entry" nzOrientation="left"></nz-divider>

            <div formArrayName="selectedStockList">
                <div *ngFor="let skill of inventoryList.controls; let i=index" [formGroupName]="i"
                    class="entry-row-container">
                    <div nz-row nzGutter="8">
                        <div nz-col [nzXs]="24" [nzMd]="12" [nzLg]="6">
                            <nz-form-item>
                                <nz-form-label>Item</nz-form-label>
                                <nz-select nzShowSearch placeholder="Select product" formControlName="medicine"
                                    (ngModelChange)="onProductSelect(i)">
                                    @for (item of inventoryListSignal(); track item.stockMasterId) {
                                    <nz-option [nzValue]="item" [nzLabel]="item.name"></nz-option>
                                    }
                                </nz-select>
                            </nz-form-item>
                        </div>
                        <div nz-col [nzXs]="8" [nzMd]="4" [nzLg]="2">
                            <nz-form-item><nz-form-label>Qty.</nz-form-label><input type="number" nz-input
                                    formControlName="qty" (input)="onValueChange(i)" /></nz-form-item>
                        </div>
                        <div nz-col [nzXs]="8" [nzMd]="4" [nzLg]="2">
                            <nz-form-item><nz-form-label>Free Qty.</nz-form-label><input type="number" nz-input
                                    formControlName="freeQty" (input)="onValueChange(i)" /></nz-form-item>
                        </div>
                        <div nz-col [nzXs]="8" [nzMd]="4" [nzLg]="2">
                            <nz-form-item><nz-form-label>Rate</nz-form-label><input type="number" nz-input
                                    formControlName="pricePerUnit" (input)="onValueChange(i)" /></nz-form-item>
                        </div>
                        <div nz-col [nzXs]="8" [nzMd]="4" [nzLg]="2">
                            <nz-form-item><nz-form-label>CC %</nz-form-label><input type="number" nz-input
                                    formControlName="ccPercent" (focus)="setLastEdited('ccPercent')"
                                    (blur)="onValueChange(i)" /></nz-form-item>
                        </div>
                        <div nz-col [nzXs]="8" [nzMd]="5" [nzLg]="3">
                            <nz-form-item><nz-form-label>CC Amt.</nz-form-label><input type="number" nz-input
                                    formControlName="ccAmt" (focus)="setLastEdited('ccAmt')"
                                    (blur)="onValueChange(i)" /></nz-form-item>
                        </div>
                        <div nz-col [nzXs]="8" [nzMd]="4" [nzLg]="3">
                            <nz-form-item><nz-form-label>Total</nz-form-label><input nz-input type="number"
                                    formControlName="totalAmt" readonly class="read-only-input" /></nz-form-item>
                        </div>
                        <div nz-col [nzXs]="8" [nzMd]="4" [nzLg]="2">
                            <nz-form-item><nz-form-label>Dis. %</nz-form-label><input type="number" nz-input
                                    formControlName="disPercent" (focus)="setLastEdited('disPercent')"
                                    (blur)="onValueChange(i)" /></nz-form-item>
                        </div>
                        <div nz-col [nzXs]="8" [nzMd]="4" [nzLg]="3">
                            <nz-form-item><nz-form-label>Dis. Amt.</nz-form-label><input type="number" nz-input
                                    formControlName="discountAmt" (focus)="setLastEdited('discountAmt')"
                                    (blur)="onValueChange(i)" /></nz-form-item>
                        </div>
                        <div nz-col [nzXs]="8" [nzMd]="4" [nzLg]="3">
                            <nz-form-item><nz-form-label>Taxable</nz-form-label><input nz-input type="number"
                                    formControlName="taxableAmt" readonly class="read-only-input" /></nz-form-item>
                        </div>
                        <div nz-col [nzXs]="8" [nzMd]="4" [nzLg]="3">
                            <nz-form-item><nz-form-label>Tax Amt.</nz-form-label><input nz-input type="number"
                                    formControlName="taxAmt" readonly class="read-only-input" /></nz-form-item>
                        </div>
                        <div nz-col [nzXs]="8" [nzMd]="4" [nzLg]="3">
                            <nz-form-item><nz-form-label>Tax (Free)</nz-form-label><input nz-input type="number"
                                    formControlName="freeTaxAmt" /></nz-form-item>
                        </div>
                        <div nz-col [nzXs]="24" [nzMd]="8" [nzLg]="3">
                            <nz-form-item>
                                <nz-form-label>Net Amt.</nz-form-label>
                                <nz-form-control>
                                    <input nz-input class="net-amt-input" formControlName="netAmt" readonly
                                        (keydown.enter)="onEnterKeyPress(i)" />
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </nz-card>

    <nz-card [nzBordered]="false" style="margin-top: 16px;">
        <nz-table #basicTable [nzBordered]="true" [nzData]="selectedItemsListSignal()" nzSize="small"
            [nzShowPagination]="false" [nzScroll]="{ x: '1300px' }">
            <thead>
                <tr>
                    <th nzWidth="40px">Sn.</th>
                    <th nzWidth="180px">Item</th>
                    <th nzWidth="60px" nzAlign="right">Qty</th>
                    <th nzWidth="60px" nzAlign="right">Free</th>
                    <th nzWidth="60px" nzAlign="right">Rate</th>
                    <th nzAlign="right">CC Amt</th>
                    <th nzAlign="right">Total</th>
                    <th nzAlign="right">Dis Amt</th>
                    <th nzAlign="right">Taxable</th>
                    <th nzAlign="right">Tax</th>
                    <th nzAlign="right">Tax(Free Item)</th>
                    <th nzWidth="150px" nzAlign="right">Net Amt</th>
                    <th nzWidth="90px" nzRight>Action</th>
                </tr>
            </thead>
            <tbody>
                @for (row of selectedItemsListSignal(); track $index) {
                <tr>
                    <td>{{ $index+1 }}.</td>
                    <td><strong>{{ row.name }}</strong></td>
                    <td nzAlign="right">{{ row.qty }}</td>
                    <td nzAlign="right">{{ row.freeQty }}</td>
                    <td nzAlign="right">{{ row.pricePerUnit | number:'1.2-2' }}</td>
                    <td nzAlign="right">{{ row.ccAmt | number:'1.2-2' }}</td>
                    <td nzAlign="right">{{ row.totalAmt | number:'1.2-2' }}</td>
                    <td nzAlign="right">{{ row.discountAmt | number:'1.2-2' }}</td>
                    <td nzAlign="right">{{ row.taxableAmt | number:'1.2-2' }}</td>
                    <td nzAlign="right">{{ row.taxAmt | number:'1.2-2' }}</td>
                    <td nzAlign="right">{{ row.freeTaxAmt | number:'1.2-2' }}</td>
                    <td nzAlign="right"><strong>{{ row.netAmt | number:'1.2-2' }}</strong></td>
                    <td nzRight>
                        <lib-table-action-buttons [showDeleteButton]="true" (edit)="onEdit(row)"
                            (delete)="onDelete(row.stockMasterId)" />
                    </td>
                </tr>
                }
            </tbody>
            <tfoot class="summary-footer">
                <tr>
                    <td colspan="5" class="footer-label">SUMMARY TOTALS</td>
                    <td nzAlign="right" class="amt-cell">{{ totalCCSignal() | number:'1.2-2' }}</td>
                    <td nzAlign="right" class="amt-cell">{{ totalGrossSignal() | number:'1.2-2' }}</td>

                    <td nzAlign="right" class="amt-cell">{{ totalDiscountSignal() | number:'1.2-2' }}</td>
                    <td nzAlign="right" class="amt-cell">{{ totalTaxableSignal() | number:'1.2-2' }}</td>
                    <td nzAlign="right" class="amt-cell">{{ totalTaxSignal() | number:'1.2-2' }}</td>
                    <td nzAlign="right" class="amt-cell">{{ totalFreeTaxSignal() | number:'1.2-2' }}</td>
                    <td nzAlign="right" class="final-net"><strong>{{ netTotalSignal() | number:'1.2-2' }}</strong></td>
                    <td></td>
                </tr>
            </tfoot>
        </nz-table>
    </nz-card>

    <div class="form-actions-bar">
        <nz-space>
            <button *nzSpaceItem nz-button nzType="default" (click)="onCancel()">Cancel</button>
            <button *nzSpaceItem nz-button nzType="primary" [nzLoading]="isSaving()" (click)="onSave()">
                <span nz-icon nzType="save"></span> Save Purchase
            </button>
        </nz-space>
    </div>
</div>